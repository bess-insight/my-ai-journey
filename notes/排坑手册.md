# ⚡ 排坑手册：Battery SoC Estimation Repo

整理运行过程中常见的问题与解决方法，便于快速复现。

---

## 1. 打不开 `.ipynb` 文件

* **问题**：PyCharm 默认不能运行 Notebook。
* **解决**：

  ```bash
  conda activate bse
  jupyter lab
  ```

  然后在浏览器访问 `http://localhost:8888` 打开 Notebook。

---

## 2. Jupyter 报 `PermissionError`

* **现象**：`PermissionError: ...\AppData\Roaming\jupyter\runtime\...`
* **原因**：Windows 用户目录权限受限。
* **解决**：

  * 在项目目录运行 `jupyter lab --notebook-dir=.`
  * 或设置环境变量 `JUPYTER_RUNTIME_DIR` 到有写权限的路径。

---

## 3. `ModuleNotFoundError: No module named 'tensorflow'`

* **原因**：Jupyter 内核没用到 conda 环境。
* **解决**：

  ```bash
  conda activate bse
  pip install ipykernel
  python -m ipykernel install --user --name=bse --display-name "Python (bse)"
  ```

  在 Notebook 右上角 Kernel → 选择 **Python (bse)**。

---

## 4. TensorFlow 与 NumPy 不兼容

* **现象**：报错 *“A module compiled with NumPy 1.x cannot be run in NumPy 2.x”*。
* **原因**：NumPy 2.x 与 TF2.10 不兼容。
* **解决**：

  ```bash
  pip install --force-reinstall "numpy==1.23.5" "scipy==1.10.1" "pandas==1.5.3" "tensorflow==2.10.1"
  pip uninstall -y keras keras-nightly keras-preprocessing keras-applications
  ```

  → 统一使用 `tensorflow.keras`。

---

## 5. `NameError: model is not defined`

* **原因**：模型 cell 没执行成功 / 内核重启后变量丢失。
* **解决**：

  * 执行顺序：① 数据准备 → ② 模型定义 → ③ `model.fit()`
  * 或 Restart Kernel → Run All。

---

## 6. 标签维度不匹配

* **现象**：`train_y.shape = (N,100,1)`，但模型输出 `(N,1)`。
* **解决方案**：

  * **Seq2one**：只取最后一步

    ```python
    train_y = train_y[:, -1, :]
    test_y  = test_y[:,  -1, :]
    ```
  * **Seq2seq**：改模型

    ```python
    model.add(LSTM(256, return_sequences=True, ...))
    model.add(TimeDistributed(Dense(1)))
    ```

---

## 7. 使用作者训练好的模型

* **路径**：`results/trained_model/xxx_best.h5` 或 `.keras`
* **用法**：

  ```python
  from tensorflow.keras.models import load_model
  model = load_model("results/trained_model/xxx_best.h5", compile=False)
  model.compile(optimizer="adam", loss="huber", metrics=["mae","mse","mape"])
  preds = model.predict(test_x)
  print(preds.shape)
  ```
* **注意**：确保 `test_x/test_y` 已准备好。

---

## 总结

* **环境问题** → 用 conda 环境隔离，固定版本（TF2.10 + NumPy1.23.5 最稳）。
* **执行顺序** → 训练前一定要跑数据和模型定义。
* **数据/模型对齐** → 根据任务选择 seq2one 或 seq2seq。
* **直接推理** → 用 `load_model` 加载作者权重即可。

---

要不要我帮你在这个手册里加一段 **“推荐环境配置”**（Python 版本、核心依赖版本列表），方便一键复现？

