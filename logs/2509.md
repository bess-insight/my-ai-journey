# 250925
# âœ… data_path = "../../" çš„çœŸæ­£å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ
è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼ˆrelative pathï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š
ä»å½“å‰ notebook æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå‘ä¸Šè·³ä¸¤çº§ç›®å½•
ç„¶åæŠŠé‚£ä¸ªç›®å½•ä½œä¸ºæ ¹ç›®å½•ï¼Œç”¨äºåç»­å¼•ç”¨æ¨¡å—æˆ–æ•°æ®ã€‚

# 250926-å­¦ä¹ æ•°æ®å¤„ç†
# ğŸ“˜ `lg_dataset.py` é€è¡Œç™½è¯è§£é‡Š

```python
import numpy as np
import pandas as pd
import logging
import plotly.graph_objects as go
from sklearn.preprocessing import MinMaxScaler
from datetime import datetime, timedelta
```

* `numpy` â†’ ç”¨æ¥å¤„ç†çŸ©é˜µå’Œæ•°ç»„ã€‚
* `pandas` â†’ ç”¨æ¥è¯» `.csv` æ–‡ä»¶ï¼Œå¤„ç†è¡¨æ ¼æ•°æ®ã€‚
* `logging` â†’ ç”¨æ¥åœ¨è¿è¡Œæ—¶æ‰“å°æ—¥å¿—ï¼ˆæ¯”å¦‚æç¤ºæœ‰ NaNï¼‰ã€‚
* `plotly.graph_objects` â†’ ç”»å›¾ç”¨çš„åº“ã€‚
* `MinMaxScaler` â†’ æœ¬æ¥ç”¨æ¥åšå½’ä¸€åŒ–ï¼ˆ0â€“1 ç¼©æ”¾ï¼‰ï¼Œä½†åœ¨æœ¬æ–‡ä»¶é‡Œå…¶å®æ²¡ç”¨åˆ°ã€‚
* `datetime, timedelta` â†’ ç”¨æ¥å¤„ç†æ—¶é—´ï¼ˆæ¯”å¦‚æŠŠå­—ç¬¦ä¸²æ—¶é—´è½¬æˆç§’æ•°ï¼‰ã€‚

---

```python
DATA_PATH = r'data/LG_18650HG2_Li-ion_Battery_Data/LG_HG2_Original_Dataset_McMasterUniversity_Jan_2020/'
```

* å®šä¹‰äº†ä¸€ä¸ªå¸¸é‡ `DATA_PATH`ï¼Œä¿å­˜ç”µæ± æ•°æ®å­˜æ”¾çš„ç›¸å¯¹è·¯å¾„ã€‚
* `r''` è¡¨ç¤º raw stringï¼ˆé¿å…è·¯å¾„é‡Œçš„åæ–œæ è½¬ä¹‰ï¼‰ã€‚

---

## å®šä¹‰ç±»ï¼š`LgData`

```python
class LgData():
    def __init__(self, base_path="./"):
        self.path = base_path + DATA_PATH
        self.logger = logging.getLogger()
```

* `class LgData` â†’ å®šä¹‰äº†ä¸€ä¸ªç±»ï¼Œç”¨æ¥å°è£…ç”µæ± æ•°æ®çš„è¯»å–å’Œå¤„ç†é€»è¾‘ã€‚
* `__init__` æ˜¯ç±»çš„åˆå§‹åŒ–å‡½æ•°ï¼š

  * `self.path` = `base_path` + `DATA_PATH`ï¼Œç»„åˆå‡ºå®Œæ•´çš„æ•°æ®ç›®å½•ï¼›
  * `self.logger` = æ—¥å¿—å·¥å…·ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æ‰“å°æç¤ºã€‚

---

## æ–¹æ³•1ï¼šè¯»å–ä¸€ä¸ªå®Œæ•´å¾ªç¯çš„æ•°æ®

```python
def get_discharge_whole_cycle(self, train_names, test_names, output_capacity=False, scale_test=False, output_time=False):
    train = self._get_data(train_names, output_capacity, output_time)
    test = self._get_data(test_names, output_capacity, output_time)
    train, test = self._scale_x(train, test, scale_test=scale_test)        
    return (train, test)
```

* å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥åŠ è½½è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„æ‰€æœ‰å¾ªç¯æ•°æ®ã€‚
* è¾“å…¥å‚æ•°ï¼š

  * `train_names` = è®­ç»ƒæ•°æ®æ–‡ä»¶ååˆ—è¡¨
  * `test_names` = æµ‹è¯•æ•°æ®æ–‡ä»¶ååˆ—è¡¨
  * `output_capacity=False` â†’ é»˜è®¤è¾“å‡º SoC ç™¾åˆ†æ¯”ï¼ˆå¦‚æœè®¾ True å°±è¾“å‡ºå®¹é‡å€¼ï¼‰
  * `scale_test=False` â†’ é»˜è®¤ä¸å¯¹æµ‹è¯•æ•°æ®åšå½’ä¸€åŒ–
  * `output_time=False` â†’ é»˜è®¤ä¸è¾“å‡ºæ—¶é—´æˆ³
* æ‰§è¡Œé€»è¾‘ï¼š

  1. ç”¨ `_get_data` åŠ è½½è®­ç»ƒæ•°æ®
  2. ç”¨ `_get_data` åŠ è½½æµ‹è¯•æ•°æ®
  3. ç”¨ `_scale_x` å¯¹æ•°æ®åšå½’ä¸€åŒ–ï¼ˆ0â€“1 ç¼©æ”¾ï¼‰
  4. è¿”å› `(train, test)`

---

## æ–¹æ³•2ï¼šè¯»å–æ•°æ®æ–‡ä»¶

```python
def _get_data(self, names, output_capacity, output_time=False):
    cycles = []
    for name in names:
        cycle = pd.read_csv(self.path + name + '.csv', skiprows=30)
```

* `_get_data` æ˜¯ä¸€ä¸ªâ€œå†…éƒ¨å‡½æ•°â€ï¼ˆå‰é¢åŠ  `_` è¡¨ç¤ºä¸å»ºè®®å¤–éƒ¨ç›´æ¥è°ƒç”¨ï¼‰ã€‚
* `names` = ä¸€æ‰¹æ–‡ä»¶åã€‚
* `pd.read_csv(...)` â†’ æ‰“å¼€ CSV æ–‡ä»¶ï¼Œè·³è¿‡å‰ 30 è¡Œï¼ˆé€šå¸¸æ˜¯å…ƒæ•°æ®ï¼‰ã€‚

```python
        cycle.columns = ['Time Stamp','Step','Status','Prog Time','Step Time','Cycle',
                        'Cycle Level','Procedure','Voltage','Current','Temperature','Capacity','WhAccu','Cnt','Empty']
```

* ç»™ CSV æ•°æ®åŠ ä¸Šåˆ—åã€‚
* å¸¸è§å­—æ®µï¼šç”µå‹ã€ç”µæµã€æ¸©åº¦ã€å®¹é‡ã€æ—¶é—´æˆ³ã€‚

```python
        cycle = cycle[(cycle["Status"] == "TABLE") | (cycle["Status"] == "DCH")]
```

* è¿‡æ»¤æ•°æ®ï¼Œåªä¿ç•™â€œæ”¾ç”µé˜¶æ®µâ€ã€‚
* â€œDCHâ€=Dischargeï¼Œâ€œTABLEâ€=ç¨³å®šè¡¨æ ¼æ•°æ®ã€‚

---

### SoC è®¡ç®—é€»è¾‘

```python
        max_discharge = abs(min(cycle["Capacity"]))
        cycle["SoC Capacity"] = max_discharge + cycle["Capacity"]
        cycle["SoC Percentage"] = cycle["SoC Capacity"] / max(cycle["SoC Capacity"])
```

* `Capacity` åœ¨ CSV é‡Œå¯èƒ½æ˜¯è´Ÿå€¼ï¼ˆæ”¾ç”µï¼‰ã€‚
* `SoC Capacity` = â€œæœ€å¤§æ”¾ç”µé‡ + å½“å‰å®¹é‡â€ï¼Œè®©å®ƒä» 0 å¼€å§‹å¢åŠ ã€‚
* `SoC Percentage` = ç”¨ `SoC Capacity / æœ€å¤§å€¼` è½¬æˆ 0â€“1 èŒƒå›´ã€‚

---

### æå–è¾“å…¥å’Œè¾“å‡º

```python
        x = cycle[["Voltage", "Current", "Temperature"]].to_numpy()
```

* `x` = è¾“å…¥ç‰¹å¾çŸ©é˜µï¼ˆä¸‰åˆ—ï¼šç”µå‹ã€ç”µæµã€æ¸©åº¦ï¼‰ã€‚

```python
        if output_capacity:
            y = cycle[["SoC Capacity"]].to_numpy()
        else:
            y = cycle[["SoC Percentage"]].to_numpy()
```

* `y` = è¾“å‡ºæ ‡ç­¾ï¼šSoC å®¹é‡æˆ–ç™¾åˆ†æ¯”ã€‚

---

### æ¸…ç† NaN

```python
        if np.isnan(np.min(x)) or np.isnan(np.min(y)):
            self.logger.info("There is a NaN in cycle " + name + ", removing row")
            x = x[~np.isnan(x).any(axis=1)]
            y = y[~np.isnan(y).any(axis=1)].reshape(-1, y.shape[1])
```

* å¦‚æœæœ‰ç¼ºå¤±å€¼ï¼ˆNaNï¼‰ï¼Œåˆ é™¤å¯¹åº”è¡Œã€‚
* é¿å…æ¨¡å‹è®­ç»ƒæ—¶æŠ¥é”™ã€‚

---

### æ”¶é›†ç»“æœ

```python
        cycles.append((x, y))
    return cycles
```

* æŠŠå½“å‰å¾ªç¯çš„ `(x, y)` å­˜å…¥åˆ—è¡¨ `cycles`ã€‚
* æœ€ç»ˆè¿”å›ä¸€ä¸ªåˆ—è¡¨ï¼Œé‡Œé¢æ˜¯æ‰€æœ‰å¾ªç¯çš„æ•°æ®å¯¹ã€‚

---

## æ–¹æ³•3ï¼šå½’ä¸€åŒ–ç‰¹å¾

```python
def _scale_x(self, train, test, scale_test=False):
    for index_feature in range(len(train[0][0][0])):
        feature_min = min([min(cycle[0][:,index_feature]) for cycle in train])
        feature_max = max([max(cycle[0][:,index_feature]) for cycle in train])
        for i in range(len(train)):
            train[i][0][:,index_feature] = (train[i][0][:,index_feature]-feature_min)/(feature_max-feature_min)
        if scale_test:
            for i in range(len(test)):
                test[i][0][:,index_feature] = (test[i][0][:,index_feature]-feature_min)/(feature_max-feature_min)
    return train, test
```

* å¯¹ `train` ä¸­çš„æ¯ä¸ªç‰¹å¾åˆ—ï¼ˆç”µå‹ã€ç”µæµã€æ¸©åº¦ï¼‰åš min-max ç¼©æ”¾ï¼š

  ```text
  (value - min) / (max - min) â†’ èŒƒå›´å˜æˆ 0â€“1
  ```
* å¦‚æœ `scale_test=True`ï¼Œåˆ™ç”¨ç›¸åŒçš„ `min/max` å¯¹æµ‹è¯•æ•°æ®ä¹Ÿåšç¼©æ”¾ã€‚

---

ğŸ‘‰ Jasonï¼Œè¿™ä¸ªæ–‡ä»¶åé¢è¿˜æœ‰ `get_stateful_cycle`ã€`get_discharge_multiple_step` ç­‰å‡½æ•°ï¼Œæˆ‘å¯ä»¥ç»§ç»­é€è¡Œæ‹†ç»™ä½ ï¼Œä¿æŒè¿™ç§â€œé€è¡Œç™½è¯+è¯­æ³•è¡¥è¯¾â€çš„é£æ ¼ã€‚

ä½ æƒ³è®©æˆ‘ç°åœ¨æ¥ç€æŠŠ **â€œæ•°æ®åˆ‡ç‰‡ï¼ˆæ»‘åŠ¨çª—å£ï¼‰éƒ¨åˆ†â€** ç»§ç»­è§£é‡Šå—ï¼Ÿ

